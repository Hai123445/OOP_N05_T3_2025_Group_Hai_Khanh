<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Tìm kiếm đơn hàng - Cà Phê Hải Khanh Thịnh" />
  <title>Tìm kiếm đơn hàng - Cà Phê Hải Khanh Thịnh</title>

  <!-- Bootstrap + Icons (giữ như mẫu) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />

  <!-- CSS lấy y hệt style mẫu -->
  <style>
    body { background: #f2ede7; font-family: system-ui, sans-serif; }
    .navbar-custom { background-color: #5a3e2b; }
    .navbar-custom .nav-link, .navbar-custom .navbar-brand { color: #f5e9de; }
    .navbar-custom .nav-link.active { font-weight: bold; text-decoration: underline; }
    .card { border-radius: 1rem; background: #fffaf5; border: 1px solid #e2d8cf; }
    .btn-action { background: #8c6d49; color: #fff; border: none; }
    .btn-action:hover { background: #6f5438; color: #fff; }
    .table-hover tbody tr:hover { background-color: #f9f3ec; }
    /* nhỏ gọn cho input nhóm */
    .search-row .form-control { max-width: 320px; }
  </style>
</head>
<body>
  <!-- Navbar: copy y chang mẫu -->
  <nav class="navbar navbar-expand-lg navbar-custom">
    <div class="container">
      <a class="navbar-brand" href="index.html">Cà Phê Hải Khanh Thịnh</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMain">
        <span class="navbar-toggler-icon"><i class="bi bi-list" style="font-size:1.25rem; color:#f5e9de;"></i></span>
      </button>
      <div class="collapse navbar-collapse" id="navMain">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link" href="index.html">Trang chủ</a></li>
          <li class="nav-item"><a class="nav-link" href="menu.html">Menu</a></li>
          <li class="nav-item"><a class="nav-link active" href="timkiem.html">Tìm đơn</a></li>
          <li class="nav-item"><a class="nav-link" href="quanli.html">Quản lý</a></li>
        </ul>

        <!-- giữ nguyên form tìm món của mẫu -->
        <form class="d-flex" role="search" action="/search" method="GET">
          <input class="form-control me-2" type="search" name="q" placeholder="Tìm món..." />
          <button class="btn btn-light btn-sm" type="submit"><i class="bi bi-search"></i></button>
        </form>
      </div>
    </div>
  </nav>

  <!-- Nội dung: card giống mẫu, bên trong có tìm kiếm + kết quả bảng -->
  <div class="container mt-4">
    <div class="card shadow-sm mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <strong>Tìm kiếm đơn hàng</strong>
      </div>

      <div class="card-body">
        <div class="row align-items-center g-2 search-row mb-3">
          <div class="col-auto">
            <input id="orderIdInput" type="number" class="form-control" placeholder="Nhập mã đơn hàng (VD: 5)" />
          </div>
          <div class="col-auto">
            <button id="btnSearch" class="btn btn-sm btn-action"><i class="bi bi-search"></i> Tìm</button>
          </div>
          <div class="col-auto">
            <button id="btnClear" class="btn btn-sm btn-secondary">Xóa</button>
          </div>
        </div>

        <!-- Nơi hiển thị kết quả -->
        <div id="resultArea">
          <div class="text-muted">Chưa có dữ liệu</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Script tìm kiếm: an toàn & resilient với nhiều cấu trúc JSON -->
  <script>
    // Escape để tránh XSS
    function escapeHtml(s) {
      if (s == null) return '';
      return String(s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // format số tiền theo locale + thêm ₫ nếu cần
    function fmtMoney(n) {
      n = Number(n) || 0;
      return new Intl.NumberFormat('vi-VN').format(n) + '₫';
    }

    // Lấy tên linh hoạt cho menuItem / nhân viên
    function getName(obj) {
      if (!obj) return '';
      return obj.name ?? obj.ten ?? obj.title ?? obj.fullName ?? '';
    }

    // Lấy số / giá linh hoạt
    function getPrice(obj) {
      if (!obj) return 0;
      return obj.price ?? obj.gia ?? obj.unitPrice ?? 0;
    }

    // Render order (hỗ trợ: single menuItem hoặc chiTiet array nếu có)
    function renderOrder(order) {
      if (!order) return '<div class="text-danger">Không có dữ liệu</div>';

      // Thu thập dữ liệu với fallback tên trường
      const id = order.id ?? order.orderId ?? '';
      const orderDateRaw = order.orderDate ?? order.order_date ?? order.createdAt ?? order.created_at ?? '';
      const orderDate = String(orderDateRaw).replace('T', ' ');
      const soLuong = order.soLuong ?? order.so_luong ?? order.quantity ?? 0;
      const thanhTien = order.thanhTien ?? order.thanh_tien ?? order.total ?? 0;

      // Nếu có menuItem (một món)
      const menuItem = order.menuItem ?? order.menu_item ?? order.item ?? null;
      const menuName = getName(menuItem);
      const menuPriceVal = getPrice(menuItem);

      // Nếu có chiTiet là array (nhiều món)
      const chiTiet = Array.isArray(order.chiTiet) ? order.chiTiet : Array.isArray(order.items) ? order.items : null;

      // Bắt đầu HTML
      let html = '';
      // Thông tin tóm tắt
      html += `<table class="table table-bordered">
        <tbody>
          <tr><th style="width:200px">Mã đơn hàng</th><td>${escapeHtml(id)}</td></tr>
          <tr><th>Ngày tạo</th><td>${escapeHtml(orderDate)}</td></tr>
          <tr><th>Nhân viên</th><td>${escapeHtml(getName(order.nhanVien ?? order.nhan_vien ?? order.employee))}</td></tr>
          <tr><th>Tổng tiền</th><td>${fmtMoney(thanhTien)}</td></tr>
        </tbody>
      </table>`;

      // Nếu có chi tiết nhiều món -> hiển thị bảng chi tiết
      if (chiTiet && chiTiet.length > 0) {
        html += `<h6>Chi tiết đơn hàng</h6>
          <table class="table table-hover align-middle">
            <thead>
              <tr>
                <th>Sản phẩm</th>
                <th class="text-end">Số lượng</th>
                <th class="text-end">Giá</th>
                <th class="text-end">Thành tiền</th>
              </tr>
            </thead>
            <tbody>
              ${chiTiet.map(it => {
                const name = escapeHtml(it.name ?? it.sanPham ?? it.ten ?? '');
                const qty = it.soLuong ?? it.quantity ?? it.qty ?? 0;
                const price = Number(it.price ?? it.gia ?? it.unitPrice ?? 0);
                const line = Number(qty) * price;
                return `<tr>
                  <td>${name}</td>
                  <td class="text-end">${escapeHtml(qty)}</td>
                  <td class="text-end">${fmtMoney(price)}</td>
                  <td class="text-end">${fmtMoney(line)}</td>
                </tr>`;
              }).join('')}
            </tbody>
          </table>`;
      } else {
        // Nếu chỉ 1 món trong DonHang (menuItem + soLuong)
        html += `<h6>Chi tiết món</h6>
          <table class="table table-hover align-middle">
            <thead>
              <tr>
                <th>Sản phẩm</th>
                <th class="text-end">Số lượng</th>
                <th class="text-end">Giá</th>
                <th class="text-end">Thành tiền</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>${escapeHtml(menuName)}</td>
                <td class="text-end">${escapeHtml(soLuong)}</td>
                <td class="text-end">${fmtMoney(menuPriceVal)}</td>
                <td class="text-end">${fmtMoney(thanhTien || (menuPriceVal * soLuong))}</td>
              </tr>
            </tbody>
          </table>`;
      }

      return html;
    }

    // Elements
    const input = document.getElementById('orderIdInput');
    const btn = document.getElementById('btnSearch');
    const btnClear = document.getElementById('btnClear');
    const resultArea = document.getElementById('resultArea');

    // Tìm kiếm
    btn.addEventListener('click', async (ev) => {
      ev.preventDefault();
      const id = String(input.value ?? '').trim();
      if (!id) {
        resultArea.innerHTML = `<div class="text-danger">Vui lòng nhập mã đơn hàng.</div>`;
        return;
      }

      resultArea.innerHTML = `<div class="text-muted">Đang tải...</div>`;
      try {
        const res = await fetch(`/api/search/orders/${encodeURIComponent(id)}`);
        if (!res.ok) {
          if (res.status === 404) {
            resultArea.innerHTML = `<div class="text-danger">Không tìm thấy đơn hàng #${escapeHtml(id)}</div>`;
          } else {
            const txt = await res.text().catch(()=>res.statusText);
            resultArea.innerHTML = `<div class="text-danger">Lỗi server: ${escapeHtml(txt)}</div>`;
          }
          return;
        }
        const order = await res.json();
        resultArea.innerHTML = renderOrder(order);
      } catch (err) {
        console.error(err);
        resultArea.innerHTML = `<div class="text-danger">Lỗi khi kết nối tới server.</div>`;
      }
    });

    // Xóa kết quả
    btnClear.addEventListener('click', (ev) => {
      ev.preventDefault();
      input.value = '';
      resultArea.innerHTML = `<div class="text-muted">Chưa có dữ liệu</div>`;
    });
  </script>
</body>
</html>
