<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý khách hàng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { background: #f2ede7; font-family: system-ui, sans-serif; }
        .navbar-custom { background-color: #5a3e2b; }
        .navbar-custom .nav-link, .navbar-custom .navbar-brand { color: #f5e9de; }
        .navbar-custom .nav-link.active { font-weight: bold; text-decoration: underline; }
        .card { border-radius: 1rem; background: #fffaf5; border: 1px solid #e2d8cf; }
        .btn-action { background: #8c6d49; color: #fff; border: none; }
        .btn-action:hover { background: #6f5438; color: #fff; }
        .table-hover tbody tr:hover { background-color: #f9f3ec; }
    </style>
</head>
<body class="p-4">

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-custom">
    <div class="container">
        <a class="navbar-brand" href="index.html">Cà Phê Hải Khanh Thịnh</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMain">
            <span class="navbar-toggler-icon"><i class="bi bi-list" style="font-size:1.25rem; color:#f5e9de;"></i></span>
        </button>
        <div class="collapse navbar-collapse" id="navMain">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item"><a class="nav-link" href="index.html">Trang chủ</a></li>
                <li class="nav-item"><a class="nav-link" href="menu.html">Menu</a></li>
                <li class="nav-item"><a class="nav-link" href="donhang.html">Đơn hàng</a></li>
                <li class="nav-item"><a class="nav-link active" href="khachhang.html">Khách hàng</a></li>
            </ul>
        </div>
    </div>
</nav>

<!-- Main Content -->
<div class="container mt-4">
    <div class="card shadow-sm mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <strong>Quản lý Khách hàng</strong>
            <button class="btn btn-sm btn-action" data-bs-toggle="modal" data-bs-target="#addCustomerModal">
                <i class="bi bi-plus-circle"></i> Thêm khách hàng
            </button>
        </div>
        <div class="card-body">
            <table class="table table-hover align-middle">
                <thead>
                <tr>
                    <th>Mã KH</th>
                    <th>Tên KH</th>
                    <th>Số điện thoại</th>
                    <th>Địa chỉ</th>
                    <th>Hành động</th>
                </tr>
                </thead>
                <tbody id="customerTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal thêm khách -->
<div class="modal fade" id="addCustomerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Thêm khách hàng mới</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addCustomerForm">
                    <div class="mb-3">
                        <label class="form-label">Mã KH</label>
                        <input type="text" class="form-control" id="customerCode" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tên khách hàng</label>
                        <input type="text" class="form-control" id="customerName" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Số điện thoại</label>
                        <input type="text" class="form-control" id="customerPhone" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Địa chỉ</label>
                        <textarea class="form-control" id="customerAddress" rows="2" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button class="btn btn-action" id="btnAddCustomerConfirm">Thêm</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal chỉnh sửa khách -->
<div class="modal fade" id="editCustomerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chỉnh sửa khách hàng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editCustomerForm">
                    <input type="hidden" id="editCustomerOldCode" />
                    <div class="mb-3">
                        <label class="form-label">Mã KH</label>
                        <input type="text" class="form-control" id="editCustomerCode" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tên khách hàng</label>
                        <input type="text" class="form-control" id="editCustomerName" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Số điện thoại</label>
                        <input type="text" class="form-control" id="editCustomerPhone" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Địa chỉ</label>
                        <textarea class="form-control" id="editCustomerAddress" rows="2" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button class="btn btn-action" id="btnUpdateCustomerConfirm">Cập nhật</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="liveToast" class="toast" role="alert">
        <div class="toast-body"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const customerTableBody = document.getElementById("customerTableBody");
const editModalEl = document.getElementById('editCustomerModal');

function escapeHtml(text) {
    return text?.replace(/[&<>"']/g, m => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
    }[m])) || '';
}

function showToast(msg, isError = false) {
    const toastEl = document.getElementById('liveToast');
    toastEl.querySelector('.toast-body').innerText = msg;
    toastEl.classList.toggle('bg-danger', isError);
    bootstrap.Toast.getOrCreateInstance(toastEl).show();
}

// Load danh sách khách hàng
async function loadCustomers() {
    try {
        const res = await fetch('/api/customers?ts=' + Date.now(), { cache: 'no-store' });
        if (!res.ok) return showToast('Lỗi khi tải dữ liệu', true);
        const items = await res.json();
        customerTableBody.innerHTML = items.map(c => `
          <tr data-code="${escapeHtml(c.code)}">
            <td>${escapeHtml(c.code)}</td>
            <td>${escapeHtml(c.name)}</td>
            <td>${escapeHtml(c.phone)}</td>
            <td>${escapeHtml(c.address)}</td>
            <td>
              <button class="btn btn-sm btn-outline-primary me-1 btn-edit"
                data-code="${escapeHtml(c.code)}"
                data-name="${escapeHtml(c.name)}"
                data-phone="${escapeHtml(c.phone)}"
                data-address="${escapeHtml(c.address)}">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn btn-sm btn-outline-danger btn-delete"
                data-code="${escapeHtml(c.code)}"
                data-name="${escapeHtml(c.name)}">
                <i class="bi bi-trash"></i>
              </button>
            </td>
          </tr>
        `).join('');
    } catch (err) {
        console.error(err);
        showToast('Không thể kết nối server', true);
    }
}

// Thêm khách hàng
document.getElementById('btnAddCustomerConfirm').addEventListener('click', async () => {
    const code = document.getElementById('customerCode').value.trim();
    const name = document.getElementById('customerName').value.trim();
    const phone = document.getElementById('customerPhone').value.trim();
    const address = document.getElementById('customerAddress').value.trim();

    if (!code || !name || !phone || !address) {
        return showToast('Vui lòng nhập đủ thông tin!', true);
    }

    try {
        const res = await fetch('/api/customers', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code, name, phone, address })
        });

        if (res.ok) {
            showToast('Thêm khách hàng thành công!');
            bootstrap.Modal.getInstance(document.getElementById('addCustomerModal'))?.hide();
            document.getElementById('addCustomerForm').reset();
            await loadCustomers();
        } else {
            const err = await res.json().catch(() => ({}));
            showToast(err.error || 'Lỗi khi thêm khách hàng', true);
        }
    } catch (err) {
        console.error(err);
        showToast('Không thể kết nối server', true);
    }
});

// Xóa khách hàng
async function removeCustomer(code, name) {
    if (!confirm(`Xóa khách hàng "${name}"?`)) return;

    try {
        const res = await fetch(`/api/customers/${encodeURIComponent(code)}`, { method: 'DELETE' });
        if (res.ok) {
            showToast(`Đã xóa "${name}"`);
            await loadCustomers();
        } else {
            const err = await res.json().catch(() => ({}));
            showToast(err.error || 'Không tìm thấy khách hàng', true);
        }
    } catch (err) {
        console.error(err);
        showToast('Không thể kết nối server', true);
    }
}

// Sửa khách hàng
document.getElementById('btnUpdateCustomerConfirm').addEventListener('click', async () => {
    const oldCode = document.getElementById('editCustomerOldCode').value.trim();
    const code = document.getElementById('editCustomerCode').value.trim();
    const name = document.getElementById('editCustomerName').value.trim();
    const phone = document.getElementById('editCustomerPhone').value.trim();
    const address = document.getElementById('editCustomerAddress').value.trim();

    if (!code || !name || !phone || !address) {
        return showToast('Vui lòng nhập đủ thông tin!', true);
    }

    try {
        const res = await fetch(`/api/customers/${encodeURIComponent(oldCode)}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code, name, phone, address })
        });

        if (res.ok) {
            showToast('Cập nhật thành công!');
            bootstrap.Modal.getInstance(editModalEl)?.hide();
            await loadCustomers();
        } else {
            const err = await res.json().catch(() => ({}));
            showToast(err.error || 'Lỗi khi cập nhật', true);
        }
    } catch (err) {
        console.error(err);
        showToast('Không thể kết nối server', true);
    }
});

// Mở modal chỉnh sửa
function openEdit(data) {
    document.getElementById('editCustomerOldCode').value = data.code;
    document.getElementById('editCustomerCode').value = data.code;
    document.getElementById('editCustomerName').value = data.name;
    document.getElementById('editCustomerPhone').value = data.phone;
    document.getElementById('editCustomerAddress').value = data.address;
    bootstrap.Modal.getOrCreateInstance(editModalEl).show();
}

// Bắt sự kiện click edit/xóa
customerTableBody.addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;
    if (btn.classList.contains('btn-delete')) {
        removeCustomer(btn.dataset.code, btn.dataset.name);
    } else if (btn.classList.contains('btn-edit')) {
        openEdit(btn.dataset);
    }
});

// Load dữ liệu ban đầu
loadCustomers();
</script>
</body>
</html>
